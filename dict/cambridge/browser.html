<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>å‰‘æ¡¥åœ¨çº¿è‹±æ±‰åŒè§£è¯å…¸ - æµè§ˆå™¨</title>
<link rel="icon" href="cdepe.png" type="image/png">
    <script src='cdepe-jquery-3.6.0.min.js'></script>
    <script src='cdepe-crypto-js.min.js'></script>
    <script src='cdepe.js'></script>
    <style>

        @import url("cdepe.css");
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        #search-container {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            gap: 10px;
        }
        
        #search-box {
            flex: 1;
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #search-btn {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        
        #search-btn:hover {
            background: #0056b3;
        }
        
        #content { flex: 1; border: 1px solid #ddd; padding: 20px; overflow: auto; position: relative; border-radius: 8px; }
    
    </style>
</head>
<body>

        <div id="search-container">
            <input type="text" id="search-box" placeholder="è¾“å…¥å•è¯..." />
            <button id="search-btn">ğŸ”</button>
        </div>
        <div id="content" class="cdepe">
            <p style="color: #666; text-align: center; margin-top: 50px;">è¾“å…¥å•è¯å¼€å§‹æœç´¢ã€‚</p>
        </div>
    
    <script>

        async function reinitializeCdepe(contentDiv) {
            try {
                document.querySelectorAll('.cdepe-nav, .cdepe-nav-dict, .cdepe-nav-sense, .cdepe-nav-sense-title').forEach(el => el.remove());
                const marker = contentDiv.querySelector('#is-cdepe-loaded');
                if (marker) marker.remove();

                const oldScript = document.getElementById('cdepe-runtime-script');
                if (oldScript) oldScript.remove();

                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.id = 'cdepe-runtime-script';
                    script.src = `cdepe.js?v=${Date.now()}`;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.body.appendChild(script);
                });
            } catch (err) {
                console.error('Error re-initializing dictionary script:', err);
            }
        }

        async function search(word, updateHistory = true) {
            if (!word) return;
            
            const contentDiv = document.getElementById('content');
            contentDiv.style.display = 'block';
            
            // ç®€å• UI åé¦ˆ
            document.body.style.cursor = 'wait';
            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) searchBtn.disabled = true;
            
            try {
                const response = await fetch(`search.php?q=${encodeURIComponent(word)}&_=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                document.body.style.cursor = 'default';
                if (searchBtn) searchBtn.disabled = false;

                if (data.found) {
                    // æˆåŠŸï¼šæ›´æ–° URL å’Œ é¡µé¢
                    if (updateHistory) {
                        const url = new URL(window.location);
                        url.searchParams.set('q', word);
                        const urlString = url.toString().replace(/\+/g, '%20');
                        window.history.pushState({ q: word }, '', urlString);
                    }
                    
                    contentDiv.innerHTML = data.content;
                    
                    await reinitializeCdepe(contentDiv);
                } else {
                    // å¤±è´¥ï¼šå§‹ç»ˆæ˜¾ç¤ºæœªæ‰¾åˆ°ï¼Œé¿å…ç™½å±
                    contentDiv.innerHTML = `<p style="text-align: center; margin-top: 50px; color: #999;">â€œ${word}â€ æœªæ‰¾åˆ°</p>`;
                }
            } catch (e) {
                document.body.style.cursor = 'default';
                if (searchBtn) searchBtn.disabled = false;

                contentDiv.innerHTML = `<p style="text-align: center; margin-top: 50px; color: red;">é”™è¯¯: ${e.message}</p>`;
            }
        }
        
        window.search = search;
        
        window.addEventListener('DOMContentLoaded', () => {
            const searchBox = document.getElementById('search-box');
            const searchBtn = document.getElementById('search-btn');
            
            const params = new URLSearchParams(window.location.search);
            const word = params.get('q') || params.get('word');
            
            if (word) {
                searchBox.value = word;
                // åˆå§‹åŒ–æ—¶æ›¿æ¢å½“å‰çŠ¶æ€ï¼Œä¸æ–°å¢å†å²è®°å½•
                const url = new URL(window.location);
                url.searchParams.set('q', word);
                window.history.replaceState({ q: word }, '', url.toString());
                search(word, false);
            }
            
            // ç›‘å¬åé€€/å‰è¿›äº‹ä»¶
            window.addEventListener('popstate', (event) => {
                const state = event.state;
                if (state && state.q) {
                    searchBox.value = state.q;
                    search(state.q, false);
                } else {
                    // å°è¯•ä» URL è·å–
                    const p = new URLSearchParams(window.location.search);
                    const w = p.get('q') || p.get('word');
                    if (w) {
                        searchBox.value = w;
                        search(w, false);
                    }
                }
            });
            
            searchBtn.addEventListener('click', () => search(searchBox.value));
            
            searchBox.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') search(searchBox.value);
            });
            
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && (href.endsWith('.mp3') || href.endsWith('.wav'))) {
                        e.preventDefault();
                        console.log('Playing audio:', href);
                        const audio = new Audio(href);
                        audio.play().catch(err => console.error('Audio play error:', err));
                    }
                }
            });
        });
    
    </script>
</body>
</html>